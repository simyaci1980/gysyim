{% extends 'layout.html' %}
{% block content %}

<div class="text-center mb-4">
    <h1>YazÄ± Ä°ÅŸleri MÃ¼dÃ¼rlÃ¼ÄŸÃ¼ NotlarÄ±</h1>
    <p>TÃ¼rkiyeâ€™de sÄ±nava hazÄ±rlananlar iÃ§in hazÄ±rlanmÄ±ÅŸ notlar ve rehber iÃ§erikler.</p>
</div>

<!-- Chat Kutusu -->
<div id="chat-container" class="border rounded p-3 mb-4 w-100" style="max-width:1000px; background:#fafafa;">
    <div id="chat-box" style="height:300px; overflow-y:auto; margin-bottom:10px;">
        <p><em>Merhaba! SorularÄ±nÄ±zÄ± buradan iletebilirsiniz.</em></p>
    </div>
    <form id="chat-form" class="d-flex">
        <input type="text" id="chat-input" class="form-control me-2" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n...">
        <button type="submit" class="btn btn-primary">GÃ¶nder</button>
    </form>
</div>

<script>
const chatForm = document.getElementById("chat-form");
const chatInput = document.getElementById("chat-input");
const chatBox = document.getElementById("chat-box");

// ğŸ”’ XSS korumasÄ± iÃ§in gÃ¼venli metin ekleme fonksiyonu
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function fetchMessages() {
    fetch("{% url 'chat_api' %}")
        .then(res => res.json())
        .then(data => {
            chatBox.innerHTML = "";
            data.forEach(msg => {
                const messageDiv = document.createElement("div");
                messageDiv.style.marginBottom = "10px";
                messageDiv.style.display = "flex";
                
                // Admin mesajÄ± mÄ±, kullanÄ±cÄ± mesajÄ± mÄ± kontrol et
                if (msg.user === "Admin") {
                    // Admin mesajÄ± - saÄŸda, yeÅŸil arka plan
                    messageDiv.style.justifyContent = "flex-end";
                    const bubble = document.createElement("div");
                    bubble.style.backgroundColor = "#d4edda";
                    bubble.style.border = "1px solid #c3e6cb";
                    bubble.style.padding = "8px 12px";
                    bubble.style.borderRadius = "10px";
                    bubble.style.maxWidth = "70%";
                    bubble.style.textAlign = "right";
                    
                    const strong = document.createElement("strong");
                    strong.textContent = "Admin";
                    strong.style.color = "#155724";
                    
                    const messageText = document.createElement("div");
                    messageText.textContent = msg.message;
                    messageText.style.marginTop = "4px";
                    
                    const small = document.createElement("small");
                    small.textContent = msg.time;
                    small.style.color = "#6c757d";
                    small.style.fontSize = "0.85em";
                    small.style.marginTop = "4px";
                    small.style.display = "block";
                    
                    bubble.appendChild(strong);
                    bubble.appendChild(messageText);
                    bubble.appendChild(small);
                    messageDiv.appendChild(bubble);
                } else {
                    // KullanÄ±cÄ±/ZiyaretÃ§i mesajÄ± - solda, gri arka plan
                    messageDiv.style.justifyContent = "flex-start";
                    const bubble = document.createElement("div");
                    bubble.style.backgroundColor = "#f8f9fa";
                    bubble.style.border = "1px solid #dee2e6";
                    bubble.style.padding = "8px 12px";
                    bubble.style.borderRadius = "10px";
                    bubble.style.maxWidth = "70%";
                    bubble.style.textAlign = "left";
                    
                    const strong = document.createElement("strong");
                    strong.textContent = msg.user;
                    strong.style.color = "#495057";
                    
                    const messageText = document.createElement("div");
                    messageText.textContent = msg.message;
                    messageText.style.marginTop = "4px";
                    
                    const small = document.createElement("small");
                    small.textContent = msg.time;
                    small.style.color = "#6c757d";
                    small.style.fontSize = "0.85em";
                    small.style.marginTop = "4px";
                    small.style.display = "block";
                    
                    bubble.appendChild(strong);
                    bubble.appendChild(messageText);
                    bubble.appendChild(small);
                    messageDiv.appendChild(bubble);
                }
                
                chatBox.appendChild(messageDiv);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });
}

fetchMessages();
setInterval(fetchMessages, 3000);

chatForm.addEventListener("submit", function(e){
    e.preventDefault();
    const text = chatInput.value.trim();
    if(!text) return;

    fetch("{% url 'chat_api' %}", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `text=${encodeURIComponent(text)}`
    }).then(res => res.json())
      .then(data => {
        if(data.status === "ok") chatInput.value = "";
      });
});

</script>

<script>
function copyIBAN() {
    // GerÃ§ek IBAN numarasÄ±
    const fullIBAN = "TR140001500158007286281178";
    
    // Panoya kopyala
    navigator.clipboard.writeText(fullIBAN).then(() => {
        // BaÅŸarÄ± mesajÄ± gÃ¶ster
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = "âœ“ KopyalandÄ±";
        button.classList.remove("btn-outline-secondary");
        button.classList.add("btn-success");
        
        // 2 saniye sonra eski haline dÃ¶ndÃ¼r
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove("btn-success");
            button.classList.add("btn-outline-secondary");
        }, 2000);
    }).catch(err => {
        alert("Kopyalama baÅŸarÄ±sÄ±z oldu. LÃ¼tfen manuel olarak kopyalayÄ±n.");
    });
}
</script>

<!-- Ã–deme Bildirimi -->
<div class="border rounded p-3 mb-4 w-100" style="max-width:1000px; background:#e9f7ef;">
    <h4>Ã–deme Yap</h4>
    <p>Ã–deme iÃ§in aÅŸaÄŸÄ±daki IBANâ€™a havale/EFT 
       <strong style="color: darkred; font-size: 1.2em;">AlÄ±cÄ± ismi: Ali AltÄ±nsoy</strong>
    </p>

    <div class="input-group mb-2">
        <input type="text" id="ibanInput" class="form-control" value="TR14 **** **** **** **81 1178" readonly>
        <button class="btn btn-outline-secondary" type="button" onclick="copyIBAN()">Kopyala</button>
    </div>

    {% comment %}
    <!-- Ã–deme bildirimi Ã¶zelliÄŸi henÃ¼z aktif deÄŸil -->
    {% if user.is_authenticated %}
    <form method="post" action="{% url 'odeme_bildirim' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-success w-100">Ã–deme Bildirimi GÃ¶nder</button>
    </form>
    {% else %}
    <p class="mt-2">Ã–deme bildiriminde bulunmak iÃ§in <a href="">giriÅŸ yapÄ±n</a>.</p>
    {% endif %}
    {% endcomment %}
</div>

<!-- Ã–rnek Sayfalar -->
<div class="border rounded p-3 mb-4 w-100" style="max-width:1000px; background:#fef9e7;">
    <h4>Ã–rnek Sayfalar</h4>
    <ul class="list-unstyled">
        <li><a href="{% url 'ornek1' %}">Ã–rnek Sayfa 1</a></li>
        <li><a href="{% url 'darisureler' %}">Ã–rnek Sayfa 2</a></li>
        <li><a href="{% url 'bim5mad' %}">Ã–rnek Sayfa 3</a></li>
    </ul>
</div>

<!-- FaydalÄ± Linkler -->
<div class="border rounded p-3 mb-4 w-100" style="max-width:1000px; background:#f2d7d5;">
    <h4>FaydalÄ± Linkler</h4>
    <ul class="list-unstyled">
        <li><a href="https://www.adalet.gov.tr/" target="_blank">Adalet BakanlÄ±ÄŸÄ±</a></li>
        <li><a href="https://pgm.adalet.gov.tr/" target="_blank">Personel Genel MÃ¼dÃ¼rlÃ¼ÄŸÃ¼</a></li>
        <li><a href="https://odsgm.meb.gov.tr/" target="_blank">Milli EÄŸitim BakanlÄ±ÄŸÄ±</a></li>
    </ul>
</div>



{% endblock %}
